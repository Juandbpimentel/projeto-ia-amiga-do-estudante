name: Provision Environment Variables (Vercel + Render)

on:
  workflow_dispatch:

jobs:
  provision:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # REMOVIDO: Passo de apt-get (curl e jq já existem nativamente)

      - name: Provision Vercel & Render env vars (idempotent)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          RENDER_TOKEN: ${{ secrets.RENDER_TOKEN }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ALLOW_ORIGINS: ${{ secrets.ALLOW_ORIGINS }}
        run: |
          set -euo pipefail
          echo "Provisioning env vars in Vercel/Render"

          # --- Helper: Vercel functions ---
          vercel_list_envs() {
            curl -s -H "Authorization: Bearer ${VERCEL_TOKEN}" "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_ID}/env"
          }

          vercel_get_env_id() {
            key="$1"
            vercel_list_envs | jq -r --arg key "$key" '.envs[] | select(.key == $key) | .id' | head -n1
          }

          vercel_create_env() {
            key="$1"; value="$2"; target="${3:-production}"
            # USO DO JQ PARA GERAR JSON SEGURO
            payload=$(jq -n --arg k "$key" --arg v "$value" --arg t "$target" '{key: $k, value: $v, target: [$t]}')
            
            curl -s -X POST "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_ID}/env" \
              -H "Authorization: Bearer ${VERCEL_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "$payload"
          }

          vercel_update_env() {
            id="$1"; value="$2"; target="${3:-production}"
            payload=$(jq -n --arg v "$value" --arg t "$target" '{value: $v, target: [$t]}')

            curl -s -X PATCH "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_ID}/env/$id" \
              -H "Authorization: Bearer ${VERCEL_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "$payload"
          }

          # --- Helper: Render functions ---
          render_list_envs() {
            curl -s -H "Authorization: Bearer ${RENDER_TOKEN}" "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/env-vars"
          }

          render_get_env_id() {
            key="$1"
            render_list_envs | jq -r --arg key "$key" '.[] | select(.key == $key) | .id' | head -n1
          }

          render_create_env() {
            key="$1"; value="$2"; secure=${3:-true}
            # Correção: secure deve ser boolean cru no JSON, não string, jq lida com isso usando --argjson para booleans se necessário, 
            # mas aqui passamos como string e o jq converte se usarmos a estrutura certa.
            payload=$(jq -n --arg k "$key" --arg v "$value" --argjson s "$secure" '{key: $k, value: $v, secure: $s}')

            curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/env-vars" \
              -H "Authorization: Bearer ${RENDER_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "$payload"
          }

          render_update_env() {
            id="$1"; value="$2"; secure=${3:-true}
            payload=$(jq -n --arg v "$value" --argjson s "$secure" '{value: $v, secure: $s}')

            curl -s -X PATCH "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/env-vars/$id" \
              -H "Authorization: Bearer ${RENDER_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "$payload"
          }

          # --- Lógica de Execução ---

          update_or_create_vercel() {
            key="$1"; value="$2"; target=${3:-production}
            if [ -z "$value" ]; then echo "Skipping Vercel env $key (empty)"; return; fi
            
            id=$(vercel_get_env_id "$key" || echo "")
            if [ -n "$id" ]; then
              echo "Updating Vercel env $key ($id)"
              vercel_update_env "$id" "$value" "$target"
            else
              echo "Creating Vercel env $key"
              vercel_create_env "$key" "$value" "$target"
            fi
          }

          update_or_create_render() {
            key="$1"; value="$2"; secure=${3:-true}
            if [ -z "$value" ]; then echo "Skipping Render env $key (empty)"; return; fi

            id=$(render_get_env_id "$key" || echo "")
            if [ -n "$id" ]; then
              echo "Updating Render env $key ($id)"
              render_update_env "$id" "$value" "$secure"
            else
              echo "Creating Render env $key"
              render_create_env "$key" "$value" "$secure"
            fi
          }

          # Provisionamento
          update_or_create_vercel BACKEND_URL "${BACKEND_URL}"
          update_or_create_vercel NEXT_PUBLIC_BACKEND_URL "${BACKEND_URL}"

          update_or_create_render BACKEND_URL "${BACKEND_URL}" true

          if [ -n "${GOOGLE_API_KEY:-}" ]; then
            update_or_create_render GOOGLE_API_KEY "${GOOGLE_API_KEY}" true
          fi
          if [ -n "${ALLOW_ORIGINS:-}" ]; then
            update_or_create_render ALLOW_ORIGINS "${ALLOW_ORIGINS}" false
          fi

      - name: Trigger Vercel production deployment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          if [ -z "${VERCEL_TOKEN:-}" ] || [ -z "${VERCEL_PROJECT_ID:-}" ]; then
            echo "VERCEL_TOKEN or VERCEL_PROJECT_ID is missing in secrets; skipping Vercel deployment"
            exit 0
          fi
          echo "Triggering Vercel deployment for project $VERCEL_PROJECT_ID"
          # Ensure jq exists
          if ! command -v jq >/dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          ref=${GITHUB_REF#refs/heads/}
          payload=$(jq -n --arg name "$VERCEL_PROJECT_ID" --arg repo "$GITHUB_REPOSITORY" --arg ref "$ref" --arg sha "$GITHUB_SHA" '{name: $name, target: "production", gitSource: { type: "github", repoId: $repo, ref: $ref, sha: $sha }}')
          response=$(curl -s -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$payload")
          url=$(echo "$response" | jq -r '.url // empty')
          if [ -n "$url" ]; then
            echo "Vercel deployment created: https://$url"
          else
            echo "Failed to create Vercel deployment; response: $response"
            exit 1
          fi
      - name: Trigger Render deployment
        env:
          RENDER_TOKEN: ${{ secrets.RENDER_TOKEN }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          if [ -z "${RENDER_TOKEN:-}" ] || [ -z "${RENDER_SERVICE_ID:-}" ]; then
            echo "RENDER_TOKEN or RENDER_SERVICE_ID missing; skipping Render deployment"
            exit 0
          fi
          echo "Triggering Render deployment for service ${RENDER_SERVICE_ID}"
          response=$(curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{}')
          id=$(echo "$response" | jq -r '.id // empty')
          state=$(echo "$response" | jq -r '.state // empty')
          if [ -n "$id" ]; then
            echo "Render deployment created: id=$id, state=$state"
            echo "Render deploy response: $response" | jq -r .
          else
            echo "Failed to create Render deployment; response: $response"
            exit 1
          fi
